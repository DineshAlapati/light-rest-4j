<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Aggregate Pattern Microservices - Light Rest 4J</title>
    <meta name="generator" content="Hugo 0.20.6" />

    
    <meta name="description" content="Light Rest 4J Docs">
    
    <link rel="canonical" href="https://networknt.github.io/light-rest-4j/tutorial/ms_aggregate/">
    
    <meta name="author" content="Steve Hu">
    

    <meta property="og:url" content="https://networknt.github.io/light-rest-4j/tutorial/ms_aggregate/">
    <meta property="og:title" content="Light Rest 4J">
    <meta property="og:image" content="https://networknt.github.io/light-rest-4j/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Light Rest 4J">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://networknt.github.io/light-rest-4j/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://networknt.github.io/light-rest-4j/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://networknt.github.io/light-rest-4j/fonts/icon.eot');
        src: url('https://networknt.github.io/light-rest-4j/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://networknt.github.io/light-rest-4j/fonts/icon.woff')
               format('woff'),
             url('https://networknt.github.io/light-rest-4j/fonts/icon.ttf')
               format('truetype'),
             url('https://networknt.github.io/light-rest-4j/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://networknt.github.io/light-rest-4j/stylesheets/application.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-rest-4j/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-rest-4j/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-rest-4j/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://networknt.github.io/light-rest-4j/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-teal">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Aggregate Pattern Microservices
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/stevehu" title="@stevehu on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/networknt/light-rest-4j" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://networknt.github.io/light-rest-4j/images/logo.png">
        </div>
      
      <div class="name">
        <strong>Light Rest 4J <span class="version">1.4.2</span></strong>
        
          <br>
          networknt/light-rest-4j
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/networknt/light-rest-4j/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/networknt/light-rest-4j/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Getting started" href="https://networknt.github.io/light-rest-4j/getting-started/">
	
	Getting started
</a>



  
</li>



<li>
  
    



<a  title="Architecture" href="https://networknt.github.io/light-rest-4j/architecture/">
	
	Architecture
</a>



  
</li>



<li>
  
    



<a  title="Design" href="https://networknt.github.io/light-rest-4j/design/">
	
	Design
</a>



  
</li>



<li>
  
    



<a  title="Middleware" href="https://networknt.github.io/light-rest-4j/middleware/">
	
	Middleware
</a>



  
</li>



<li>
  
    



<a  title="Other Component" href="https://networknt.github.io/light-rest-4j/other/">
	
	Other Component
</a>



  
</li>



<li>
  
    



<a  title="DevOps" href="https://networknt.github.io/light-rest-4j/devops/">
	
	DevOps
</a>



  
</li>



<li>
  
    



<a  title="Benchmark" href="https://networknt.github.io/light-rest-4j/benchmark/">
	
	Benchmark
</a>



  
</li>



<li>
  
    



<a  title="Tutorial" href="https://networknt.github.io/light-rest-4j/tutorial/">
	
	Tutorial
</a>



  
</li>



<li>
  
    



<a  title="Example" href="https://networknt.github.io/light-rest-4j/example/">
	
	Example
</a>



  
</li>



<li>
  
    



<a  title="Tool" href="https://networknt.github.io/light-rest-4j/tool/">
	
	Tool
</a>



  
</li>



<li>
  
    



<a  title="Issues &amp; Help" href="https://github.com/networknt/light-rest-4j/issues">
	
	Issues &amp; Help
</a>



  
</li>



<li>
  
    



<a  title="Roadmap" href="https://networknt.github.io/light-rest-4j/roadmap/">
	
	Roadmap
</a>



  
</li>



<li>
  
    



<a  title="License" href="https://www.apache.org/licenses/LICENSE-2.0">
	
	License
</a>



  
</li>



<li>
  
    



<a  title="Introduction" href="https://networknt.github.io/light-rest-4j/index.html">
	
	Introduction
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          

          
          <li>
            <a href="https://github.com/stevehu" target="_blank" title="@stevehu on GitHub">
              @stevehu on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:stevehu@gmail.com" title="Email of stevehu@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Aggregate Pattern Microservices </h1>

			

<p>This is another pattern that is very useful for serving mobile native applications. The mobile
app just send one request to the aggregate API and it will call multiple APIs to gether info
and send back to the consumer. This avoid mobile device to call multiple APIs to get data on a
slow network.</p>

<p>This tutorial shows you how to build 4 services with one of them the aggregator. And it will
be the foundation for our microserives benchmarks.</p>

<pre><code>
API A -&gt; API B
      -&gt; API C
      -&gt; API D
</code></pre>

<p>API A calls API B, API C and API D to fulfill its request.</p>

<h2 id="prepare-workspace">Prepare workspace</h2>

<p>All specifications and code of the services are on github.com but we are going to
redo it again by following the steps in the tutorial. Let&rsquo;s first create a
workspace. I have created a directory named networknt under user directory.</p>

<p>Checkout related projects.</p>

<pre><code>cd ~/networknt
git clone git@github.com:networknt/light-codegen.git
git clone git@github.com:networknt/light-example-4j.git
git clone git@github.com:networknt/model-config.git
git clone git@github.com:networknt/light-oauth2.git
git clone git@github.com:networknt/light-docker.git

</code></pre>

<p>As we are going to regenerate API A, B, C and D, let&rsquo;s rename ms_aggregate folder from
light-example-4j.</p>

<pre><code>cd ~/networknt/light-example-4j/rest
mv ms_aggregate ms_aggregate.bak
cd ~/networknt
</code></pre>

<h2 id="specifications">Specifications</h2>

<p>Light-rest-4j microservices framework encourages Design Driven API building and
<a href="https://github.com/OAI/OpenAPI-Specification">OpenAPI Specification</a> is the central
piece to drive the runtime for security and validation. Also, the specification
can be used to scaffold a running server project the first time so that developers
can focus their efforts on the domain business logic implementation without
worrying about how each component are wired together.</p>

<p>During the service implementation phase, specification might be changed and you can
regenerate the service codebase again without overwriting your handlers and test
cases for handlers. The regeneration is also useful if you want to upgrade to the
latest version of the frameworks for your project.</p>

<p>To create OpenAPI(Swagger) specification, the best tool is
<a href="http://swagger.io/swagger-editor/">swagger-editor</a> and I have an
<a href="https://networknt.github.io/light-rest-4j/tools/swagger-editor/">article</a>
in tools section to describe how to use it.</p>

<p>By following the <a href="https://networknt.github.io/light-rest-4j/tools/swagger-editor/">instructions</a>
on how to use the editor, let&rsquo;s create four API specifications in model-config repository.</p>

<p>API A will call API B, API C and API D</p>

<pre><code>API A -&gt; API B 
      -&gt; API C 
      -&gt; API D
</code></pre>

<p>Here is the API A swagger.yaml and others can be found at
<a href="https://github.com/networknt/model-config/tree/master/rest">https://github.com/networknt/model-config</a>
or model-config/rest folder in your workspace.</p>

<pre><code>swagger: '2.0'

info:
  version: &quot;1.0.0&quot;
  title: API A for microservices demo
  description: API A is called by consumer directly and it will call API B and API C to get data
  contact:
    email: stevehu@gmail.com
  license:
    name: &quot;Apache 2.0&quot;
    url: &quot;http://www.apache.org/licenses/LICENSE-2.0.html&quot;
host: a.networknt.com
schemes:
  - http
basePath: /v1

consumes:
  - application/json
produces:
  - application/json

paths:
  /data:
    get:
      description: Return an array of strings collected from down stream APIs
      operationId: listData
      responses:
        200:
          description: Successful response
          schema:
            title: ArrayOfStrings
            type: array
            items:
              type: string
          examples: {
            &quot;application/json&quot;: [&quot;Message 1&quot;,&quot;Message 2&quot;]
          }
      security:
        - a_auth:
          - api_a.w
          - api_a.r

securityDefinitions:
  a_auth:
    type: oauth2
    authorizationUrl: http://localhost:8080/oauth2/code
    flow: implicit
    scopes:
      api_a.w: write access
      api_a.r: read access
</code></pre>

<p>As defined in the specification, API A will return a list of stings and it requires
scope api_a.r or scope api_a.w to access the endpoint /data.</p>

<h2 id="light-codegen">light-codegen</h2>

<p>Now we have four API swagger.yaml files available. Let&rsquo;s use light-codegen
to start four projects in light-example-4j/rest/ms_aggregate. In normal API build, you
should create a repo for each API. For us, we have to user light-example-4j for all the
examples and tutorial for easy management in networknt github organization.</p>

<h4 id="build-light-codege">Build light-codege</h4>

<p>The project is cloned to the local already during the prepare stage. Let&rsquo;s build it.</p>

<pre><code>cd light-codegen
mvn clean install -DskipTests
</code></pre>

<h4 id="prepare-generator-config">Prepare Generator Config</h4>

<p>Each generator in light-codegen requires several parameters to control how the generator
works. For more information on how to use generator, please refer <a href="https://networknt.github.io/light-codegen/generator/">here</a></p>

<p>For API A, here is the config.json and a copy can be found in the folder
model-config/rest/api_a/1.0.0 along with swagger.yaml and swagger.json.</p>

<pre><code>{
  &quot;name&quot;: &quot;apia&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;groupId&quot;: &quot;com.networknt&quot;,
  &quot;artifactId&quot;: &quot;apia&quot;,
  &quot;rootPackage&quot;: &quot;com.networknt.apia&quot;,
  &quot;handlerPackage&quot;:&quot;com.networknt.apia.handler&quot;,
  &quot;modelPackage&quot;:&quot;com.networknt.apia.model&quot;,
  &quot;overwriteHandler&quot;: true,
  &quot;overwriteHandlerTest&quot;: true,
  &quot;overwriteModel&quot;: true,
  &quot;httpPort&quot;: 7001,
  &quot;enableHttp&quot;: true,
  &quot;httpsPort&quot;: 7441,
  &quot;enableHttps&quot;: true,
  &quot;enableRegistry&quot;: false,
  &quot;supportOracle&quot;: false,
  &quot;supportMysql&quot;: false,
  &quot;supportPostgresql&quot;: false,
  &quot;supportH2ForTest&quot;: false,
  &quot;supportClient&quot;: true
}
</code></pre>

<p>As you can see the generated project will use 7001 for http and 7441 for https and client
module will be included as it will call API B, C, D with it. DB dependencies are not required for
this tutorial.</p>

<h4 id="generate-first-project">Generate first project</h4>

<p>Now you have your light-codegen built, let&rsquo;s generate a project. Assume that
model-config, light-example-4j and light-codegen are in the same working
directory ~/networknt and you are in ~/networknt/light-codegen now.</p>

<pre><code>cd ~/networknt/light-codegen
java -jar codegen-cli/target/codegen-cli.jar -f light-rest-4j -o ../light-example-4j/rest/ms_aggregate/api_a/generated -m ../model-config/rest/api_a/1.0.0/swagger.json -c ../model-config/rest/api_a/1.0.0/config.json
</code></pre>

<h4 id="build-and-run-the-mock-api">Build and run the mock API</h4>

<p>And now you have a new project created in light-example-4j/rest/ms_aggregate/api_a/generated.
Let&rsquo;s build it and run the test cases. If everything is OK, start the server.</p>

<pre><code>cd ..
cd light-example-4j/rest/ms_aggregate/api_a/generated
mvn clean install exec:exec
</code></pre>

<p>Let&rsquo;s test the API A by issuing the following command</p>

<pre><code>curl localhost:7001/v1/data
</code></pre>

<p>By default the generated response example will be returned.</p>

<pre><code> [&quot;Message 1&quot;,&quot;Message 2&quot;]
</code></pre>

<p>As https port is enable, let&rsquo;s test https connection and the result should be the same.</p>

<pre><code>curl -k https://localhost:7441/v1/data
</code></pre>

<h4 id="generate-other-apis">Generate other APIs</h4>

<p>Let&rsquo;s kill the API A by Ctrl+C and move to the light-codegen terminal again. Follow
the above steps to generate other APIs. Make sure you are in light_codegen
directory.</p>

<pre><code>cd ~/networknt/light-codegen
java -jar codegen-cli/target/codegen-cli.jar -f light-rest-4j -o ../light-example-4j/rest/ms_aggregate/api_b/generated -m ../model-config/rest/api_b/1.0.0/swagger.json -c ../model-config/rest/api_b/1.0.0/config.json
java -jar codegen-cli/target/codegen-cli.jar -f light-rest-4j -o ../light-example-4j/rest/ms_aggregate/api_c/generated -m ../model-config/rest/api_c/1.0.0/swagger.json -c ../model-config/rest/api_c/1.0.0/config.json
java -jar codegen-cli/target/codegen-cli.jar -f light-rest-4j -o ../light-example-4j/rest/ms_aggregate/api_d/generated -m ../model-config/rest/api_d/1.0.0/swagger.json -c ../model-config/rest/api_d/1.0.0/config.json
</code></pre>

<p>Now you have four APIs generated from four OpenAPI specifications. Let&rsquo;s check
them in. Note that you might not have write access to this repo, so you can ignore
this step.</p>

<pre><code>cd ../light-example-4j
git add .
git commit -m &quot;checkin 4 apis&quot;
git push origin master
</code></pre>

<h2 id="apitoapi-http">ApiToApi Http</h2>

<p>Now these APIs are working if you start them and they will output the mock responses
generated based on the API specifications. Let&rsquo;s take a look at the API handler itself
and update it based on our business logic, you can call API A and subsequently all other
APIs will be called by API A.</p>

<h4 id="prepare-environment">Prepare Environment</h4>

<p>Before starting this step, let&rsquo;s create a folder called httpaggregate in each sub folder under
ms_aggregate and copy everything from generated folder to the httpaggregate. We are going to update
httpaggregate folder to have business logic to call another api and change the configuration
to listen to different port. You can compare between generated and httpaggregate to see what has
been changed later on.</p>

<pre><code>cd ~/networknt/light-example-4j/rest/ms_aggregate/api_a
cp -r generated httpaggregate
cd ~/networknt/light-example-4j/rest/ms_aggregate/api_b
cp -r generated httpaggregate
cd ~/networknt/light-example-4j/rest/ms_aggregate/api_c
cp -r generated httpaggregate
cd ~/networknt/light-example-4j/rest/ms_aggregate/api_d
cp -r generated httpaggregate

</code></pre>

<p>Now we have httpaggregate folder copied from generated and all updates in this step will be
in httpaggregate folder.</p>

<h4 id="api-d">API D</h4>

<p>Let&rsquo;s take a look at the PathHandlerProvider.java in
ms_aggregate/api_d/httpaggregate/src/main/java/com/networknt/apid</p>

<pre><code>package com.networknt.apid;

import com.networknt.config.Config;
import com.networknt.server.HandlerProvider;
import io.undertow.Handlers;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.Methods;
import com.networknt.info.ServerInfoGetHandler;
import com.networknt.health.HealthGetHandler;
import com.networknt.apid.handler.*;

public class PathHandlerProvider implements HandlerProvider {
    @Override
    public HttpHandler getHandler() {
        return Handlers.routing()
        
            .add(Methods.GET, &quot;/v1/data&quot;, new DataGetHandler())
        
            .add(Methods.GET, &quot;/v1/health&quot;, new HealthGetHandler())
        
            .add(Methods.GET, &quot;/v1/server/info&quot;, new ServerInfoGetHandler())
        
        ;
    }
}
</code></pre>

<p>This is the only class that routes each endpoint defined in specification to a handler
instance. Because we only have one endpoint /v1/data@get there is only one route added
to the handler chain. And there is a handler generated in the handler subfolder to
handle request that has the url matched to this endpoint. The /server/info is injected
to output the server runtime information on all the components and configurations. It
will be included in every API/service. /health is another injected endpoint to output
server health check info with 200 response code and &ldquo;OK&rdquo; as the body. It should be
disabled in most of the case, but Kubernetes needs it.</p>

<p>The generated handler is named &ldquo;DataGetHandler&rdquo; and it returns example response defined
in swagger specification. Here is the generated handler code.</p>

<pre><code>
package com.networknt.apid.handler;

import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.Map;

public class DataGetHandler implements HttpHandler {
    @Override
    public void handleRequest(HttpServerExchange exchange) throws Exception {
        
            exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
             exchange.getResponseSender().send(&quot; [\n                                \&quot;Message 1\&quot;,\n                                \&quot;Message 2\&quot;\n                            ]&quot;);
        
    }
}
</code></pre>

<p>Let&rsquo;s update it to an array of strings that indicates the response comes from API D.</p>

<pre><code>package com.networknt.apid.handler;

import com.networknt.config.Config;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class DataGetHandler implements HttpHandler {
    @Override
    public void handleRequest(HttpServerExchange exchange) throws Exception {
        List&lt;String&gt; messages = new ArrayList&lt;String&gt;();
        messages.add(&quot;API D: Message 1&quot;);
        messages.add(&quot;API D: Message 2&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(messages));
    }
}
</code></pre>

<p>Now, let&rsquo;s build it and start the server.</p>

<pre><code>cd ~/networknt/light-example-4j/rest/ms_aggregate/api_d/httpaggregate
mvn clean install exec:exec
</code></pre>

<p>Test it with curl.</p>

<pre><code>curl localhost:7004/v1/data
</code></pre>

<p>And the result is</p>

<pre><code>[&quot;API D: Message 1&quot;,&quot;API D: Message 2&quot;]
</code></pre>

<p>Test with HTTPS port and you should have the same result.</p>

<pre><code>curl -k https://localhost:7444/v1/data
</code></pre>

<p>Note that we have -k option to in the https command line as we are using self-signed
certificate and we don&rsquo;t want to verify the domain.</p>

<h4 id="api-c">API C</h4>

<p>Let&rsquo;s leave API D running and update API C DataGetHandler in
~/networknt/light-example-4j/rest/ms_aggregate/api_c/httpaggregate</p>

<pre><code>package com.networknt.apic.handler;

import com.networknt.config.Config;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class DataGetHandler implements HttpHandler {
    @Override
    public void handleRequest(HttpServerExchange exchange) throws Exception {
        List&lt;String&gt; messages = new ArrayList&lt;String&gt;();
        messages.add(&quot;API C: Message 1&quot;);
        messages.add(&quot;API C: Message 2&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(messages));
    }
}

</code></pre>

<p>Start API C server and test the endpoint /v1/data</p>

<pre><code>cd ~/networknt/light-example-4j/rest/ms_aggregate/api_c/httpaggregate
mvn clean install exec:exec
</code></pre>

<p>From another terminal window run:</p>

<pre><code>curl localhost:7003/v1/data
</code></pre>

<p>And the result is</p>

<pre><code>[&quot;API D: Message 1&quot;,&quot;API D: Message 2&quot;,&quot;API C: Message 1&quot;,&quot;API C: Message 2&quot;]
</code></pre>

<p>Access https port should have the same result.</p>

<pre><code>curl -k https://localhost:7443/v1/data

</code></pre>

<h4 id="api-b">API B</h4>

<p>Let&rsquo;s keep API C and API D running. The next step is to complete API B.</p>

<p>Now let&rsquo;s update the generated DataGetHandler.java to this.</p>

<pre><code>package com.networknt.apib.handler;

import com.networknt.config.Config;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class DataGetHandler implements HttpHandler {
    @Override
    public void handleRequest(HttpServerExchange exchange) throws Exception {
        List&lt;String&gt; messages = new ArrayList&lt;String&gt;();
        messages.add(&quot;API B: Message 1&quot;);
        messages.add(&quot;API B: Message 2&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(messages));
    }
}
</code></pre>

<p>Start API B server and test the endpoint /v1/data</p>

<pre><code>cd ~/networknt/light-example-4j/rest/ms_aggregate/api_b/httpaggregate
mvn clean install exec:exec
</code></pre>

<p>From another terminal window run:</p>

<pre><code>curl localhost:7002/v1/data
</code></pre>

<p>And the result is</p>

<pre><code>[&quot;API D: Message 1&quot;,&quot;API D: Message 2&quot;,&quot;API C: Message 1&quot;,&quot;API C: Message 2&quot;,&quot;API B: Message 1&quot;,&quot;API B: Message 2&quot;]
</code></pre>

<p>Here is the https port and the result is the same.</p>

<pre><code>curl -k https://localhost:7442/v1/data

</code></pre>

<h4 id="api-a">API A</h4>

<p>API A will call API B, C, D to fulfill its request. Now let&rsquo;s update the
generated DataGetHandler.java code to</p>

<pre><code>package com.networknt.apia.handler;

import com.fasterxml.jackson.core.type.TypeReference;
import com.networknt.client.Client;
import com.networknt.config.Config;
import com.networknt.exception.ClientException;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import org.apache.http.HttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.concurrent.FutureCallback;
import org.apache.http.impl.nio.client.CloseableHttpAsyncClient;

import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Vector;
import java.util.concurrent.CountDownLatch;

public class DataGetHandler implements HttpHandler {
    static String CONFIG_NAME = &quot;api_a&quot;;
    static String apibUrl = (String) Config.getInstance().getJsonMapConfig(CONFIG_NAME).get(&quot;api_b_endpoint&quot;);
    static String apicUrl = (String) Config.getInstance().getJsonMapConfig(CONFIG_NAME).get(&quot;api_c_endpoint&quot;);
    static String apidUrl = (String) Config.getInstance().getJsonMapConfig(CONFIG_NAME).get(&quot;api_d_endpoint&quot;);

    @Override
    public void handleRequest(HttpServerExchange exchange) throws Exception {
        List&lt;String&gt; list = new Vector&lt;String&gt;();
        final HttpGet[] requests = new HttpGet[] {
                new HttpGet(apibUrl),
                new HttpGet(apicUrl),
                new HttpGet(apidUrl),
        };
        try {
            CloseableHttpAsyncClient client = Client.getInstance().getAsyncClient();
            final CountDownLatch latch = new CountDownLatch(requests.length);
            for (final HttpGet request: requests) {
                Client.getInstance().propagateHeaders(request, exchange);
                client.execute(request, new FutureCallback&lt;HttpResponse&gt;() {
                    @Override
                    public void completed(final HttpResponse response) {
                        try {
                            List&lt;String&gt; apiList = Config.getInstance().getMapper().readValue(response.getEntity().getContent(),
                                    new TypeReference&lt;List&lt;String&gt;&gt;(){});
                            list.addAll(apiList);
                        } catch (IOException e) {
                            e.printStackTrace();
                        }
                        latch.countDown();
                    }

                    @Override
                    public void failed(final Exception ex) {
                        ex.printStackTrace();
                        latch.countDown();
                    }

                    @Override
                    public void cancelled() {
                        System.out.println(&quot;cancelled&quot;);
                        latch.countDown();
                    }
                });
            }
            latch.await();
        } catch (ClientException e) {
            e.printStackTrace();
            throw new Exception(&quot;ClientException:&quot;, e);
        }
        // now add API A specific messages
        list.add(&quot;API A: Message 1&quot;);
        list.add(&quot;API A: Message 2&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(list));
    }
}
</code></pre>

<p>API A needs to have the urls of API B, C and D in order to call them. Let&rsquo;s put it in a config file for
now and move to service discovery later.</p>

<p>Create api_a.yml in src/main/resources/config folder.</p>

<pre><code>api_b_endpoint: http://localhost:7002/v1/data
api_c_endpoint: http://localhost:7003/v1/data
api_d_endpoint: http://localhost:7004/v1/data

</code></pre>

<p>Start API A server and test the endpoint /v1/data</p>

<pre><code>cd ~/networknt/light-example-4j/rest/ms_aggregate/api_a/httpaggregate
mvn clean install exec:exec
</code></pre>

<p>From another terminal window run:</p>

<pre><code>curl localhost:7001/v1/data
</code></pre>

<p>And the result is</p>

<pre><code>[&quot;API D: Message 1&quot;,&quot;API D: Message 2&quot;,&quot;API C: Message 1&quot;,&quot;API C: Message 2&quot;,&quot;API B: Message 1&quot;,&quot;API B: Message 2&quot;,&quot;API A: Message 1&quot;,&quot;API A: Message 2&quot;]
</code></pre>

<p>The https port and the result should be the same.</p>

<pre><code> curl -k https://localhost:7441/v1/data
</code></pre>

<p>At this moment, we have all four APIs completed and A is calling B, C and D using Http connections.</p>

<h2 id="performance-with-http">Performance with Http</h2>

<p>Now let&rsquo;s see if these servers are performing with
<a href="https://github.com/wg/wrk">wrk</a>. To learn how to use it, please see my
article in tools <a href="https://networknt.github.io/light-4j/tools/wrk-perf/">here</a></p>

<p>Assume you have wrk installed, run the following command.</p>

<pre><code>wrk -t4 -c128 -d30s http://localhost:7001 -s pipeline.lua --latency -- /v1/data 1024

</code></pre>

<p>And here is what I got on my i5 desktop</p>

<pre><code>wrk -t4 -c128 -d30s http://localhost:7001 -s pipeline.lua --latency -- /v1/data 1024
Running 30s test @ http://localhost:7001
  4 threads and 128 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.00us    0.00us   0.00us    -nan%
    Req/Sec     5.31k     7.02k   21.29k    80.30%
  Latency Distribution
     50%    0.00us
     75%    0.00us
     90%    0.00us
     99%    0.00us
  157184 requests in 30.05s, 36.13MB read
  Socket errors: connect 0, read 0, write 0, timeout 128
Requests/sec:   5230.92
Transfer/sec:      1.20MB
</code></pre>

<p>Before starting the next step, please kill all four instances by Ctrl+C. And check in
the httpaggregate folder we just created and updated.</p>

<p>For more steps, please refer to</p>

<p><a href="https://networknt.github.io/light-rest-4j/tutorial/ms-chain/">https://networknt.github.io/light-rest-4j/tutorial/ms-chain/</a></p>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://networknt.github.io/light-rest-4j/tutorial/ms-branch/" title="Branch Pattern Microservices">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Branch Pattern Microservices
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://networknt.github.io/light-rest-4j/tool/" title="Tools">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Tools
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/networknt.github.io\/light-rest-4j\/';
      var repo_id  = 'networknt\/light-rest-4j';
    
    </script>

    <script src="https://networknt.github.io/light-rest-4j/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

